<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <title>SMARTWORK – บันทึกผลงาน</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- โหลด SCRIPT_URL (ตัวเดียวทั้งระบบ) -->
    <script src="config.js"></script>

    <style>
      body {
        font-family: "TH Sarabun New", "Sarabun", sans-serif;
        background: #f3f3f3;
        margin: 0;
        padding: 15px;
      }
      .container {
        max-width: 840px;
        margin: auto;
        background: #fff;
        padding: 22px 28px;
        border-radius: 14px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
      }
      .header-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .avatar-small {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        object-fit: cover;
      }
      h2 {
        margin: 0;
        text-align: center;
      }
      label {
        font-size: 18px;
        font-weight: 600;
      }
      input,
      select,
      textarea {
        width: 100%;
        padding: 8px 10px;
        font-size: 18px;
        border-radius: 8px;
        border: 1px solid #bbb;
        margin-bottom: 12px;
      }
      textarea {
        height: 130px;
      }
      button {
        width: 100%;
        padding: 12px;
        font-size: 20px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        margin-top: 8px;
      }
      #submitBtn {
        background: #1e4bb8;
        color: white;
      }
      #navIndex {
        background: #0a7b34;
        color: white;
      }
      #navReport {
        background: #8a5300;
        color: white;
      }
      .preview-row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      .preview-row img {
        width: 120px;
        height: 90px;
        object-fit: cover;
        border-radius: 8px;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div class="header-row">
        <div>
          <h2>บันทึกผลงาน (SMARTWORK)</h2>
        </div>
        <img
          id="avatarHeader"
          class="avatar-small"
          src="https://via.placeholder.com/60x60?text=Avatar"
        />
      </div>

      <form id="workForm" onsubmit="return false;">
        <label>ชื่อ - สกุล</label>
        <input id="fullname" disabled />

        <label>ตำแหน่ง</label>
        <input id="position" disabled />

        <label>สังกัด</label>
        <input id="unit" disabled />

        <label>วันที่ของกิจกรรม</label>
        <input type="date" id="workDate" required />

        <label>ชื่องาน</label>
        <input id="title" required />

        <label>รายละเอียดงาน</label>
        <textarea id="detail" required></textarea>

        <label>ตัวชี้วัด</label>
        <select id="indicator" required>
          <option value="">— เลือก —</option>
          <option value="1) จัดการเรียนรู้ตามหลักสูตร">1) จัดการเรียนรู้ตามหลักสูตร</option>
          <option value="2) ส่งเสริมสนับสนุนการเรียนรู้">2) ส่งเสริมสนับสนุนการเรียนรู้</option>
          <option value="3) นิเทศ กำกับ ติดตาม">3) นิเทศ กำกับ ติดตาม</option>
          <option value="4) ปฏิบัติงานอื่นตามที่ได้รับมอบหมาย">4) ปฏิบัติงานอื่นตามที่ได้รับมอบหมาย</option>
        </select>

        <label>ลิงก์ผลงาน (ถ้ามี)</label>
        <input id="url" placeholder="ไม่บังคับ" />

        <label>เลือกรูปภาพ (สูงสุด 6 รูป)</label>
        <input type="file" id="images" accept="image/*" multiple />
        <div id="preview" class="preview-row"></div>

        <button id="submitBtn">บันทึกผลงาน</button>
        <button id="navIndex" type="button">ดูรายการผลงาน</button>
        <button id="navReport" type="button">ออกบันทึกข้อความ</button>
      </form>
    </div>

    <script>
      // โหลด Config ผู้ใช้
      const cfg = JSON.parse(localStorage.getItem("SMARTWORK_CONFIG") || "{}");

      if (!cfg.fullname) {
        Swal.fire("ยังไม่ได้ตั้งค่า", "โปรดตั้งค่าที่ config.html", "warning");
      }

      // แสดงข้อมูล
      fullname.value = cfg.fullname || "";
      position.value = cfg.position || "";
      unit.value = "สกร.อ." + (cfg.district || "") + " สกร.จังหวัดศรีสะเกษ";

      if (cfg.avatarDataUrl) avatarHeader.src = cfg.avatarDataUrl;

      // Preview รูป
      images.onchange = () => {
        preview.innerHTML = "";
        [...images.files].forEach((file) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = document.createElement("img");
            img.src = e.target.result;
            preview.appendChild(img);
          };
          reader.readAsDataURL(file);
        });
      };

      // Resize
      function resizeImage(file) {
        return new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
              let w = img.width;
              let h = img.height;
              const MAX = 1280;
              if (w > h && w > MAX) {
                h *= MAX / w;
                w = MAX;
              } else if (h > MAX) {
                w *= MAX / h;
                h = MAX;
              }
              const canvas = document.createElement("canvas");
              canvas.width = w;
              canvas.height = h;
              canvas.getContext("2d").drawImage(img, 0, 0, w, h);
              resolve(canvas.toDataURL("image/jpeg", 0.85));
            };
            img.src = e.target.result;
          };
          reader.readAsDataURL(file);
        });
      }

      // Submit
      submitBtn.onclick = async () => {
        if (!workDate.value || !title.value || !detail.value || !indicator.value) {
          Swal.fire("กรุณากรอกข้อมูลให้ครบ", "", "warning");
          return;
        }

        Swal.fire({ title: "กำลังบันทึก...", didOpen: () => Swal.showLoading() });

        const resized = [];
        for (const f of [...images.files].slice(0, 6)) {
          resized.push(await resizeImage(f));
        }

        const payload = {
          name: cfg.fullname,
          pos: cfg.position,
          unit: "สกร.อ." + cfg.district,
          workDate: workDate.value,
          title: title.value.trim(),
          detail: detail.value.trim(),
          indicator: indicator.value,
          url: url.value.trim(),
          pics: resized,
        };

        try {
          const res = await fetch(SCRIPT_URL, {
            method: "POST",
            body: JSON.stringify(payload),
          });
          const json = await res.json();

          if (json.status === "OK") {
            // เก็บรูป proxy ไว้ใช้กับ report
            const picsProxy = json.pics.map(
              (id) => SCRIPT_URL + "?mode=image&id=" + id
            );

            localStorage.setItem(
              "LATEST_WORK",
              JSON.stringify({ ...payload, pics: picsProxy })
            );

            Swal.fire("บันทึกสำเร็จ", "", "success");
          } else {
            Swal.fire("ผิดพลาด", json.message, "error");
          }
        } catch (err) {
          Swal.fire("ผิดพลาด", err.message, "error");
        }
      };

      // ไปหน้า index
      navIndex.onclick = () => (location.href = "index.html");
      navReport.onclick = () => (location.href = "report.html");
    </script>
  </body>
</html>
